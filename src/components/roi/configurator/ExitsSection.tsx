import { useState, useCallback, useMemo } from "react";
import { LogOut, Plus, Trash2, Calendar, Sparkles, Pencil, Check, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Input } from "@/components/ui/input";
import { ConfiguratorSectionProps, months } from "./types";
import { formatCurrency } from "../currencyUtils";

interface ExitScenario {
  id: string;
  label: string;
  monthsFromBooking: number;
  isAutoGenerated: boolean;
}

export const ExitsSection = ({ inputs, setInputs, currency }: ConfiguratorSectionProps) => {
  const [exitScenariosEnabled, setExitScenariosEnabled] = useState(
    inputs.enabledSections?.exitStrategy ?? true
  );
  const [customExits, setCustomExits] = useState<ExitScenario[]>([]);
  const [isAddingCustom, setIsAddingCustom] = useState(false);
  const [customMonths, setCustomMonths] = useState<number>(12);
  const [editingExitId, setEditingExitId] = useState<string | null>(null);
  const [editingMonths, setEditingMonths] = useState<number>(0);

  // Calculate months from booking to handover
  const bookingDate = useMemo(() => new Date(inputs.bookingYear, inputs.bookingMonth - 1), [inputs.bookingYear, inputs.bookingMonth]);
  const handoverQuarterMonth = useMemo(() => (inputs.handoverQuarter - 1) * 3 + 1, [inputs.handoverQuarter]);
  const handoverDate = useMemo(() => new Date(inputs.handoverYear, handoverQuarterMonth - 1), [inputs.handoverYear, handoverQuarterMonth]);
  const totalMonths = useMemo(() => Math.max(1, Math.round((handoverDate.getTime() - bookingDate.getTime()) / (1000 * 60 * 60 * 24 * 30))), [bookingDate, handoverDate]);

  // Auto-generate exits based on timeline - improved rule for longer construction periods
  const autoGeneratedExits = useMemo((): ExitScenario[] => {
    const exits: ExitScenario[] = [];
    
    // For any construction period, we generate at most 3 well-spaced exits + handover
    // The spacing ensures exits are meaningful and not too close together
    
    if (totalMonths >= 30) {
      // Long construction (30+ months): 3 exits evenly spaced
      // Exit at ~40%, ~70%, ~90% of construction + handover
      const exit1 = Math.round(totalMonths * 0.4);
      const exit2 = Math.round(totalMonths * 0.7);
      const exit3 = Math.round(totalMonths * 0.9);
      
      exits.push({
        id: 'auto-early',
        label: `${exit1} months`,
        monthsFromBooking: exit1,
        isAutoGenerated: true,
      });
      exits.push({
        id: 'auto-mid',
        label: `${exit2} months`,
        monthsFromBooking: exit2,
        isAutoGenerated: true,
      });
      exits.push({
        id: 'auto-late',
        label: `${exit3} months`,
        monthsFromBooking: exit3,
        isAutoGenerated: true,
      });
    } else if (totalMonths >= 18) {
      // Medium construction (18-30 months): 2 exits
      const exit1 = Math.round(totalMonths * 0.5);
      const exit2 = Math.round(totalMonths * 0.85);
      
      exits.push({
        id: 'auto-mid',
        label: `${exit1} months`,
        monthsFromBooking: exit1,
        isAutoGenerated: true,
      });
      exits.push({
        id: 'auto-late',
        label: `${exit2} months`,
        monthsFromBooking: exit2,
        isAutoGenerated: true,
      });
    } else if (totalMonths >= 12) {
      // Short construction (12-18 months): 1 exit
      const exit1 = Math.round(totalMonths * 0.7);
      exits.push({
        id: 'auto-late',
        label: `${exit1} months`,
        monthsFromBooking: exit1,
        isAutoGenerated: true,
      });
    }
    
    // Always include handover
    exits.push({
      id: 'handover',
      label: 'Handover',
      monthsFromBooking: totalMonths,
      isAutoGenerated: true,
    });
    
    return exits;
  }, [totalMonths]);

  // Combine auto and custom exits
  const allExits = useMemo(() => {
    return [...autoGeneratedExits, ...customExits].sort((a, b) => a.monthsFromBooking - b.monthsFromBooking);
  }, [autoGeneratedExits, customExits]);

  // Calculate exit details
  const getExitDetails = useCallback((monthsFromBooking: number) => {
    const exitPercent = (monthsFromBooking / totalMonths) * 100;
    const exitYears = monthsFromBooking / 12;
    
    const annualRate = inputs.constructionAppreciation ?? 12;
    const exitValue = inputs.basePrice * Math.pow(1 + annualRate / 100, exitYears);
    const appreciation = exitValue - inputs.basePrice;
    const appreciationPercent = (appreciation / inputs.basePrice) * 100;
    
    let equityPercent = inputs.downpaymentPercent;
    inputs.additionalPayments.forEach(p => {
      if (p.type === 'time' && p.triggerValue <= monthsFromBooking) {
        equityPercent += p.paymentPercent;
      } else if (p.type === 'construction' && p.triggerValue <= exitPercent) {
        equityPercent += p.paymentPercent;
      }
    });
    
    if (monthsFromBooking >= totalMonths) {
      equityPercent = 100;
    }
    
    const equityDeployed = inputs.basePrice * (equityPercent / 100);
    const profit = appreciation;
    const roe = equityDeployed > 0 ? (profit / equityDeployed) * 100 : 0;
    
    return { exitValue, appreciation, appreciationPercent, equityDeployed, equityPercent, profit, roe };
  }, [inputs, totalMonths]);

  const handleToggle = (enabled: boolean) => {
    setExitScenariosEnabled(enabled);
    setInputs(prev => ({
      ...prev,
      enabledSections: {
        ...prev.enabledSections,
        exitStrategy: enabled,
        longTermHold: prev.enabledSections?.longTermHold ?? true,
      },
    }));
  };

  const handleAddCustomExit = () => {
    if (customMonths > 0 && customMonths < totalMonths) {
      const newExit: ExitScenario = {
        id: `custom-${Date.now()}`,
        label: `${customMonths} months`,
        monthsFromBooking: customMonths,
        isAutoGenerated: false,
      };
      setCustomExits(prev => [...prev, newExit]);
      setIsAddingCustom(false);
      setCustomMonths(12);
    }
  };

  const handleRemoveExit = (exitId: string) => {
    setCustomExits(prev => prev.filter(e => e.id !== exitId));
  };

  const handleStartEdit = (exit: ExitScenario) => {
    setEditingExitId(exit.id);
    setEditingMonths(exit.monthsFromBooking);
  };

  const handleSaveEdit = (exitId: string) => {
    if (editingMonths > 0 && editingMonths < totalMonths) {
      setCustomExits(prev => prev.map(e => 
        e.id === exitId 
          ? { ...e, monthsFromBooking: editingMonths, label: `${editingMonths} months` }
          : e
      ));
    }
    setEditingExitId(null);
  };

  const handleCancelEdit = () => {
    setEditingExitId(null);
  };

  const getExitDate = (monthsFromBooking: number): string => {
    const date = new Date(bookingDate);
    date.setMonth(date.getMonth() + monthsFromBooking);
    return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  };

  return (
    <div className="space-y-4">
      <div>
        <h3 className="text-lg font-semibold text-white mb-0.5">Exit Scenarios</h3>
        <p className="text-xs text-gray-500">Configure when you might exit this investment</p>
      </div>

      {/* Enable Toggle */}
      <div className="flex items-center justify-between p-3 bg-[#1a1f2e] rounded-lg border border-[#2a3142]">
        <div className="flex items-center gap-2">
          <LogOut className="w-4 h-4 text-[#CCFF00]" />
          <span className="text-sm text-gray-300">Enable Exit Analysis</span>
        </div>
        <Switch
          checked={exitScenariosEnabled}
          onCheckedChange={handleToggle}
          className="data-[state=checked]:bg-[#CCFF00]"
        />
      </div>

      {exitScenariosEnabled && (
        <>
          {/* Timeline Info + Auto-generated combined */}
          <div className="flex items-center justify-between p-2.5 bg-[#0d1117] rounded-lg border border-[#2a3142]">
            <div className="flex items-center gap-2 text-xs text-gray-400">
              <Calendar className="w-3.5 h-3.5 shrink-0" />
              <span>{totalMonths}mo construction</span>
            </div>
            <div className="flex items-center gap-1.5">
              <Sparkles className="w-3 h-3 text-[#CCFF00]" />
              <span className="text-xs text-[#CCFF00]">{autoGeneratedExits.length} auto-exits</span>
            </div>
          </div>

          {/* Exit Scenarios List - Compact */}
          <div className="space-y-1.5">
            {allExits.map((exit) => {
              const details = getExitDetails(exit.monthsFromBooking);
              const isEditing = editingExitId === exit.id;
              
              return (
                <div
                  key={exit.id}
                  className={`p-2.5 rounded-lg border ${
                    exit.isAutoGenerated 
                      ? 'bg-[#1a1f2e] border-[#2a3142]' 
                      : 'bg-[#1a1f2e] border-[#CCFF00]/30'
                  }`}
                >
                  <div className="flex items-center justify-between gap-2">
                    {/* Left: Label + Date */}
                    <div className="flex items-center gap-2 min-w-0 flex-1">
                      {isEditing ? (
                        <div className="flex items-center gap-1.5">
                          <Input
                            type="number"
                            value={editingMonths}
                            onChange={(e) => setEditingMonths(parseInt(e.target.value) || 0)}
                            min={1}
                            max={totalMonths - 1}
                            className="w-14 h-6 text-xs bg-[#0d1117] border-[#2a3142] text-white font-mono px-1.5"
                          />
                          <span className="text-[10px] text-gray-500">mo</span>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => handleSaveEdit(exit.id)}
                            className="h-5 w-5 p-0 text-green-400 hover:text-green-300"
                          >
                            <Check className="w-3 h-3" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={handleCancelEdit}
                            className="h-5 w-5 p-0 text-gray-500 hover:text-gray-300"
                          >
                            <X className="w-3 h-3" />
                          </Button>
                        </div>
                      ) : (
                        <>
                          <span className="text-xs font-medium text-white truncate">{exit.label}</span>
                          <span className="text-[10px] text-gray-500 shrink-0">{getExitDate(exit.monthsFromBooking)}</span>
                          {!exit.isAutoGenerated && (
                            <span className="text-[9px] bg-[#CCFF00]/20 text-[#CCFF00] px-1 py-0.5 rounded shrink-0">
                              Custom
                            </span>
                          )}
                        </>
                      )}
                    </div>
                    
                    {/* Center: Metrics */}
                    <div className="flex items-center gap-3 shrink-0">
                      <div className="text-right">
                        <div className="text-xs font-mono text-white font-semibold">
                          {formatCurrency(details.exitValue, currency)}
                        </div>
                      </div>
                      <div className="text-right w-12">
                        <div className="text-xs font-mono text-green-400 font-semibold">
                          +{details.appreciationPercent.toFixed(0)}%
                        </div>
                      </div>
                      <div className="text-right w-10">
                        <div className="text-xs font-mono text-[#CCFF00] font-semibold">
                          {details.roe.toFixed(0)}%
                        </div>
                      </div>
                    </div>

                    {/* Right: Actions */}
                    {!exit.isAutoGenerated && !isEditing && (
                      <div className="flex items-center gap-0.5 shrink-0">
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => handleStartEdit(exit)}
                          className="h-5 w-5 p-0 text-gray-500 hover:text-blue-400"
                        >
                          <Pencil className="w-3 h-3" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => handleRemoveExit(exit.id)}
                          className="h-5 w-5 p-0 text-gray-500 hover:text-red-400"
                        >
                          <Trash2 className="w-3 h-3" />
                        </Button>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Column Headers */}
          <div className="flex items-center justify-end gap-3 px-2.5 text-[9px] text-gray-500 uppercase tracking-wider">
            <span>Value</span>
            <span className="w-12 text-right">Gain</span>
            <span className="w-10 text-right">ROE</span>
            <span className="w-11"></span>
          </div>

          {/* Add Custom Exit */}
          {!isAddingCustom ? (
            <Button
              variant="outline"
              size="sm"
              onClick={() => setIsAddingCustom(true)}
              className="w-full h-8 text-xs bg-[#0d1117] border-[#CCFF00]/30 text-[#CCFF00] hover:bg-[#CCFF00]/20"
            >
              <Plus className="w-3 h-3 mr-1" />
              Add Custom Exit
            </Button>
          ) : (
            <div className="p-3 bg-[#1a1f2e] rounded-lg border border-[#CCFF00]/30 space-y-2">
              <div className="flex items-center gap-2">
                <label className="text-xs text-gray-400 shrink-0">Exit at:</label>
                <Input
                  type="number"
                  value={customMonths}
                  onChange={(e) => setCustomMonths(parseInt(e.target.value) || 0)}
                  min={1}
                  max={totalMonths - 1}
                  className="w-16 h-7 text-xs bg-[#0d1117] border-[#2a3142] text-white font-mono"
                />
                <span className="text-xs text-gray-500">months (of {totalMonths})</span>
              </div>
              <div className="flex gap-2">
                <Button
                  size="sm"
                  onClick={handleAddCustomExit}
                  disabled={customMonths <= 0 || customMonths >= totalMonths}
                  className="flex-1 h-7 text-xs bg-[#CCFF00] text-black hover:bg-[#CCFF00]/90"
                >
                  Add
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setIsAddingCustom(false)}
                  className="h-7 text-xs border-[#2a3142] text-gray-400"
                >
                  Cancel
                </Button>
              </div>
            </div>
          )}

          {/* Minimum Exit Threshold */}
          <div className="p-2.5 bg-[#1a1f2e] rounded-lg border border-[#2a3142]">
            <div className="flex justify-between items-center">
              <span className="text-xs text-gray-400">Min. exit threshold</span>
              <span className="text-xs text-white font-mono">{inputs.minimumExitThreshold}%</span>
            </div>
          </div>
        </>
      )}
    </div>
  );
};
